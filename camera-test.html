<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        video { width: 100%; max-width: 400px; height: 300px; background: black; border: 2px solid #ccc; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ</h1>
    <p>ã“ã®ãƒšãƒ¼ã‚¸ã§ã‚«ãƒ¡ãƒ©ãŒå‹•ä½œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
    
    <video id="video" autoplay playsinline muted></video>
    
    <div>
        <button onclick="startBasicCamera()">åŸºæœ¬ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
        <button onclick="startRearCamera()">ãƒªã‚¢ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
        <button onclick="stopCamera()">ã‚«ãƒ¡ãƒ©åœæ­¢</button>
        <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>
    <div style="margin-top: 10px;">
        <button onclick="checkEnvironment()">ç’°å¢ƒå†ãƒã‚§ãƒƒã‚¯</button>
        <button onclick="listDevices()">ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§</button>
        <button onclick="forcePermissionRequest()" style="background: #ff6b6b; color: white;">ğŸš¨ å¼·åˆ¶æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
        <button onclick="showPermissionHelp()">æ¨©é™è¨­å®šãƒ˜ãƒ«ãƒ—</button>
    </div>
    
    <div id="status">ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†</div>
    <div id="log" class="log"></div>

    <script>
        const video = document.getElementById('video');
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        let currentStream = null;

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            log.innerHTML = '';
        }

        function updateStatus(message) {
            status.textContent = message;
            addLog(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${message}`);
        }

        async function startBasicCamera() {
            addLog('ğŸ”§ åŸºæœ¬ã‚«ãƒ¡ãƒ©é–‹å§‹');
            stopCamera();
            
            try {
                updateStatus('ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèªä¸­...');
                addLog('getUserMediaå‘¼ã³å‡ºã—: { video: true }');
                
                currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = currentStream;
                
                addLog('âœ… ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ');
                updateStatus('ã‚«ãƒ¡ãƒ©å‹•ä½œä¸­');
                
                video.onloadedmetadata = () => {
                    addLog(`ğŸ“ ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º: ${video.videoWidth}x${video.videoHeight}`);
                };
                
            } catch (error) {
                addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`);
                updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function startRearCamera() {
            addLog('ğŸ”§ ãƒªã‚¢ã‚«ãƒ¡ãƒ©é–‹å§‹');
            stopCamera();
            
            try {
                updateStatus('ãƒªã‚¢ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’ç¢ºèªä¸­...');
                addLog('getUserMediaå‘¼ã³å‡ºã—: facingMode environment');
                
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = currentStream;
                
                addLog('âœ… ãƒªã‚¢ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—æˆåŠŸ');
                updateStatus('ãƒªã‚¢ã‚«ãƒ¡ãƒ©å‹•ä½œä¸­');
                
                video.onloadedmetadata = () => {
                    addLog(`ğŸ“ ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚º: ${video.videoWidth}x${video.videoHeight}`);
                };
                
            } catch (error) {
                addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`);
                updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                
                // Fallback to basic camera
                addLog('ğŸ“± åŸºæœ¬ã‚«ãƒ¡ãƒ©ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                startBasicCamera();
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => {
                    track.stop();
                    addLog(`ğŸ›‘ ãƒˆãƒ©ãƒƒã‚¯åœæ­¢: ${track.label}`);
                });
                currentStream = null;
                video.srcObject = null;
                updateStatus('ã‚«ãƒ¡ãƒ©åœæ­¢');
            }
        }

        // è©³ç´°ãªç’°å¢ƒãƒã‚§ãƒƒã‚¯
        function checkEnvironment() {
            addLog('ğŸ“± ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            addLog(`ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent}`);
            addLog(`ğŸ“ URL: ${window.location.href}`);
            addLog(`ğŸ”’ ãƒ—ãƒ­ãƒˆã‚³ãƒ«: ${window.location.protocol}`);
            addLog(`ğŸ“· MediaDeviceså¯¾å¿œ: ${!!navigator.mediaDevices}`);
            addLog(`ğŸ¥ getUserMediaå¯¾å¿œ: ${!!navigator.mediaDevices?.getUserMedia}`);
            
            // Check if HTTPS
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                addLog('âŒ HTTPSå¿…é ˆ: ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«ã¯HTTPSæ¥ç¶šãŒå¿…è¦ã§ã™');
                updateStatus('ã‚¨ãƒ©ãƒ¼: HTTPSæ¥ç¶šãŒå¿…è¦');
                return false;
            }
            
            // Check permissions API
            if ('permissions' in navigator) {
                navigator.permissions.query({name: 'camera'}).then(result => {
                    addLog(`ğŸ” ã‚«ãƒ¡ãƒ©æ¨©é™çŠ¶æ…‹: ${result.state}`);
                    if (result.state === 'denied') {
                        addLog('âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™');
                        addLog('ğŸ’¡ è§£æ±ºæ–¹æ³•: ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦å´ã®ğŸ”’ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯â†’ã‚«ãƒ¡ãƒ©â†’è¨±å¯');
                        updateStatus('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ - ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                    }
                }).catch(err => {
                    addLog(`âš ï¸ æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${err.message}`);
                });
            }
            
            return true;
        }

        // ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§å–å¾—
        async function listDevices() {
            try {
                addLog('ğŸ“± ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§å–å¾—ä¸­...');
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                addLog(`ğŸ“¹ æ¤œå‡ºã•ã‚ŒãŸã‚«ãƒ¡ãƒ©æ•°: ${videoDevices.length}`);
                videoDevices.forEach((device, index) => {
                    addLog(`ğŸ“¹ ã‚«ãƒ¡ãƒ©${index + 1}: ${device.label || 'Unknown Camera'} (ID: ${device.deviceId})`);
                });
                
                if (videoDevices.length === 0) {
                    addLog('âŒ ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    updateStatus('ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãªã—');
                }
            } catch (error) {
                addLog(`âŒ ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // æ¨©é™è¨­å®šãƒ˜ãƒ«ãƒ—
        function showPermissionHelp() {
            const helpText = `
ğŸ“‹ ã‚«ãƒ¡ãƒ©æ¨©é™è¨­å®šæ–¹æ³•:

ğŸ”´ Chrome/Edge:
1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ğŸ”’ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ã€Œã‚«ãƒ¡ãƒ©ã€ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´
3. ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°

ğŸ”´ Safari:
1. Safari â†’ è¨­å®š â†’ Webã‚µã‚¤ãƒˆ â†’ ã‚«ãƒ¡ãƒ©
2. ã“ã®ã‚µã‚¤ãƒˆã‚’ã€Œè¨±å¯ã€ã«è¨­å®š
3. ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°

ğŸ”´ Firefox:
1. ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦ã®ğŸ”’ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ã€Œæ¥ç¶šã®è©³ç´°ã€â†’ã€Œãã®ä»–ã®æƒ…å ±ã€
3. ã€Œè¨±å¯è¨­å®šã€ã§ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯

ğŸ”´ ãƒ¢ãƒã‚¤ãƒ«:
- ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ãƒ—ãƒªã®è¨­å®šã§ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯
- ãƒ‡ãƒã‚¤ã‚¹è¨­å®šã§ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯

ç¾åœ¨ã®URL: ${window.location.href}
            `;
            
            alert(helpText);
            addLog('ğŸ’¡ æ¨©é™è¨­å®šãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }

        // ã‚ˆã‚Šç©æ¥µçš„ãªã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ
        async function forcePermissionRequest() {
            addLog('ğŸš¨ å¼·åˆ¶çš„ãªæ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹');
            
            try {
                // Try to trigger permission dialog
                updateStatus('æ¨©é™ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { min: 1 },
                        height: { min: 1 }
                    } 
                });
                
                addLog('âœ… æ¨©é™å–å¾—æˆåŠŸ');
                video.srcObject = stream;
                currentStream = stream;
                updateStatus('ã‚«ãƒ¡ãƒ©å‹•ä½œä¸­');
                
            } catch (error) {
                addLog(`âŒ æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.name} - ${error.message}`);
                
                if (error.name === 'NotAllowedError') {
                    addLog('ğŸš« ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦ã—ã¾ã—ãŸ');
                    showPermissionHelp();
                } else if (error.name === 'NotFoundError') {
                    addLog('ğŸ“· ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                } else {
                    addLog(`â“ ä¸æ˜ãªã‚¨ãƒ©ãƒ¼: ${error.name}`);
                }
                
                updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // åˆæœŸåŒ–
        checkEnvironment();
        listDevices();
    </script>
</body>
</html>